<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Paws Pet House - Quản lý Lịch hẹn</title>
    <link rel="stylesheet" href="QLLH-NV.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
  </head>
  <body>
    <!-- Header ngang trên cùng -->
    <header class="site-header">
      <div class="logo">
        <img
          src="https://i.imgur.com/YpwJQhA.png"
          alt="Paw Logo"
          class="logo-icon"
        />
        PAWS PET HOUSE
      </div>
    </header>

    <!-- Chia 2 cột: sidebar + nội dung -->
    <div class="app-container">
      <!-- Sidebar trái -->
      <aside class="sidebar">
        <nav class="nav-menu">
          <a href="QLDV.html"><i class="fas fa-cogs"></i> Quản lý dịch vụ</a>
          <a href="QLTK.html"><i class="fas fa-user"></i> Quản lý tài khoản</a>
          <a class="active" href="#"><i class="fas fa-calendar-alt"></i> Quản lý lịch hẹn</a>
          <a href="QLTT.html"><i class="fas fa-folder-open"></i> Quản lý thông tin</a>
        </nav>
      </aside>

    <!-- Nội dung phải -->
    <div class="content-area">
            <!-- BREADCRUMB + ADMIN -->
            <div class="topbar">
              <span class="breadcrumb">Trang chủ / <strong>Quản lý lịch hẹn</strong></span>
              <div class="user-admin">
                <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="Avatar" class="avatar">
                Admin
              </div>
            </div>
          
        <!-- QUẢN LÝ LỊCH HẸN -->
        <div class="table-container">
          <h3 class="table-title">DANH SÁCH LỊCH HẸN</h3>
          <!-- TÌM KIẾM + BỘ LỌC + THÊM MỚI -->
          <!-- === THANH CÔNG CỤ ĐÃ SỬA LẠI ĐÚNG CẤU TRÚC === -->
<div class="table-toolbar">
  <div class="toolbar-left">
    <div class="search-group">
      <input type="text" placeholder="Tìm kiếm" class="search-box" />
      <button class="search-button">
        <i class="fas fa-search"></i>
      </button>
    </div>
    <button class="filter-button">
      <i class="fas fa-filter"></i> Bộ lọc
      <i class="fas fa-caret-down"></i>
    </button>
    
    <!-- Panel lọc cho Lịch hẹn -->
    <div class="filter-panel" id="appointmentFilterPanel">
      <h4>BỘ LỌC LỊCH HẸN</h4>
      <div class="filter-group">
          <label for="dateFromFilter">Từ ngày</label>
          <input type="date" id="dateFromFilter">
      </div>
      <div class="filter-group">
          <label for="dateToFilter">Đến ngày</label>
          <input type="date" id="dateToFilter">
      </div>
      <div class="filter-group">
        <label for="serviceFilter">Dịch vụ</label>
        <select id="serviceFilter">
          <option value="all">Tất cả dịch vụ</option>
          <option value="Tắm rửa">Tắm rửa</option>
          <option value="Tạo kiểu lông">Tạo kiểu lông</option>
          <option value="Khách sạn thú cưng">Khách sạn thú cưng</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="paymentFilter">Tình trạng thanh toán</label>
        <select id="paymentFilter">
          <option value="all">Tất cả</option>
          <option value="Chưa thanh toán">Chưa thanh toán</option>
          <option value="Đã thanh toán">Đã thanh toán</option> <!-- Thêm option này nếu cần -->
        </select>
      </div>
      <div class="filter-actions">
        <button class="btn-reset-filter">Đặt lại</button>
        <button class="btn-apply-filter">Áp dụng</button>
      </div>
    </div>
  </div>
  <button class="add-button">
    <i class="fas fa-plus white-icon"></i>
    Thêm mới
  </button>
</div>

              <!-- BẢNG DỮ LIỆU LỊCH HẸN -->
              <table class="appointment-table">
                <thead>
                  <tr>
                    <th>Mã lịch hẹn</th>
                    <th>Ngày hẹn</th>
                    <th>Giờ hẹn</th>
                    <th>Khách hàng</th>   
                    <th>Số điện thoại</th>                 
                    <th>Thú cưng</th>
                    <th>Dịch vụ</th>
                    <th>Thanh toán</th>
                    <th>Tác vụ</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td data-id="appointmentId">LH001</td>
                    <td data-id="appointmentDate">2025-05-15</td>
                    <td data-id="appointmentTime">10:00</td>
                    <td data-id="customerName">Phạm Hoàng Hưng</td>
                    <td data-id="phoneNumber">0842672987</td>
                    <td data-id="petName">Bánh bao</td>
                    <td data-id="service">Tắm rửa</td>
                    <td>Chưa thanh toán</td>
                    <td>
                      <button class="icon-button edit-button" onclick="openEditModal(this)">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="icon-button invoice-button" onclick="openInvoiceModal(this)">
                        <i class="fas fa-file-invoice"></i>
                      </button>
                      <button class="icon-button delete-button" onclick="showDeletePopup()">
                        <i class="fas fa-times"></i>
                      </button>                     
                    </td>
                  </tr>
                </tbody>
              </table>

              <!-- MODAL CHỈNH SỬA LỊCH HẸN -->
              <div id="editModal" class="modal" style="display: none">
                <div class="modal-content">
                  <span class="close-btn" onclick="closeEditModal()">&times;</span>
                  <h3 id="modalTitle">Chỉnh sửa lịch hẹn</h3>
                  <form id="editAppointmentForm">
                    <label for="appointmentId">Mã lịch hẹn:</label>
                    <input type="text" id="appointmentId" name="appointmentId" readonly />

                    <label for="customerName">Khách hàng:</label>
                    <input type="text" id="customerName" name="customerName" required />

                    <label for="phoneNumber">Số điện thoại:</label>
                    <input type="text" id="phoneNumber" name="phoneNumber" required />

                    <label for="appointmentDate">Ngày hẹn:</label>
                    <input type="date" id="appointmentDate" name="appointmentDate" required />

                    <label for="appointmentTime">Khung giờ:</label>
                    <select id="appointmentTime" required>
                      <option value="" disabled selected hidden>-- Chọn khung giờ --</option>
                      <option value="08:00">08:00</option>
                      <option value="10:00">10:00</option>
                      <option value="14:00">14:00</option>
                      <option value="16:00">16:00</option>
                    </select>

                    <label for="petName">Thú cưng:</label>
                    <select id="petName" required>
                      <option value="" disabled selected hidden>-- Chọn thú cưng --</option>
                      <option value="banhbao">Bánh bao</option>
                      <option value="new" style="color:#880e4f;">Thêm mới...</option>
                    </select>

                    <label for="service">Loại dịch vụ:</label>
                    <select id="service" required>
                      <option value="" disabled selected hidden>-- Chọn dịch vụ --</option>
                      <option value="tamrua">Tắm rửa</option>
                      <option value="kham">Tạo kiểu lông</option>
                      <option value="khachsan">Khách sạn thú cưng</option>
                    </select>    

                    <button type="submit" class="save-button" id="modalSubmitButton">Lưu thay đổi</button>
                  </form>
                </div>
              </div>

              <!-- MODAL XUẤT HÓA ĐƠN -->
              <div id="invoiceModal" class="modal" style="display: none">
                <div class="modal-content">
                  <span class="close-btn" onclick="closeInvoiceModal()">×</span>
                  <h3>Xuất Hóa Đơn</h3>
                  <div id="invoice-details">
                    <p><strong>Mã lịch hẹn:</strong> <span id="invoiceAppointmentId"></span></p>
                    <p><strong>Khách hàng:</strong> <span id="invoiceCustomerName"></span></p>
                    <p><strong>Số điện thoại:</strong> <span id="invoicePhoneNumber"></span></p>
                    <p><strong>Ngày hẹn:</strong> <span id="invoiceAppointmentDate"></span></p>
                    <p><strong>Thú cưng:</strong> <span id="invoicePetName"></span></p>
                    <p><strong>Dịch vụ:</strong> <span id="invoiceService"></span></p>
                    <p><strong>Giá tiền:</strong> <span id="invoicePrice"></span></p>
                  </div>
                  <button type="button" class="save-button" onclick="processInvoice()">Xuất hóa đơn</button>
                </div>
              </div>
              
              <!-- POP-UP HỦY LỊCH HẸN -->
              <div id="cancel-popup" class="popup-overlay">
                <div class="popup-box">
                  <div class="popup-header">HỦY LỊCH HẸN</div>
                  <div class="popup-body">
                    <div class="popup-content">
                      <img src="https://png.pngtree.com/png-vector/20230314/ourmid/pngtree-hazard-icon-vector-png-image_6647993.png" class="warning-icon" alt="Warning">
                      <p>Bạn có chắc chắn muốn hủy lịch hẹn đã chọn?</p>
                    </div>
                    <div class="popup-actions">
                      <button class="btn btn-confirm">Xác nhận</button>
                      <button class="btn btn-cancel">Quay lại</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- PHÂN TRANG -->
              <div class="pagination">
                <button class="page-btn">«</button>
                <span>Trang</span>
                <input type="number" value="1" min="1" class="page-input" />
                <span>/ 10</span>
                <button class="page-btn">»</button>
              </div>
            
        </div>
      </div>
    </div>
  </div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- KHAI BÁO BIẾN TOÀN CỤC ---
        const editModal = document.getElementById("editModal");
        const editForm = document.getElementById("editAppointmentForm");
        const modalTitle = document.getElementById("modalTitle");
        const modalSubmitButton = document.getElementById("modalSubmitButton");
        const addButton = document.querySelector(".add-button");
        const tableBody = document.querySelector(".appointment-table tbody");
        // Bỏ dòng khai báo allAppointmentRows ở đây

        // ===== CODE BỘ LỌC =====
        const filterButton = document.querySelector(".filter-button");
        const filterPanel = document.getElementById("appointmentFilterPanel");

        // 1. Hiện/ẩn panel lọc
        filterButton.addEventListener("click", (event) => {
            event.stopPropagation();
            filterPanel.classList.toggle("active");
        });

        // 2. Ẩn panel khi click ra ngoài
        document.addEventListener("click", () => {
            if (filterPanel.classList.contains("active")) {
                filterPanel.classList.remove("active");
            }
        });
        filterPanel.addEventListener("click", (event) => event.stopPropagation());

        // 3. Xử lý nút "Áp dụng"
        filterPanel.querySelector(".btn-apply-filter").addEventListener("click", () => {
            // Lấy danh sách hàng MỖI KHI LỌC để bao gồm cả các hàng mới thêm
            const allRowsToFilter = Array.from(tableBody.querySelectorAll("tr"));
            const dateFrom = filterPanel.querySelector("#dateFromFilter").value;
            const dateTo = filterPanel.querySelector("#dateToFilter").value;
            const service = filterPanel.querySelector("#serviceFilter").value;
            const payment = filterPanel.querySelector("#paymentFilter").value;

            allRowsToFilter.forEach(row => {
                const rowDate = row.cells[1].textContent.trim();
                const rowService = row.cells[6].textContent.trim();
                const rowPayment = row.cells[7].textContent.trim();

                const dateMatch = (!dateFrom || rowDate >= dateFrom) && (!dateTo || rowDate <= dateTo);
                const serviceMatch = (service === "all") || (rowService === service);
                const paymentMatch = (payment === "all") || (rowPayment === payment);

                row.style.display = (dateMatch && serviceMatch && paymentMatch) ? "" : "none";
            });

            filterPanel.classList.remove("active");
        });

        // 4. Xử lý nút "Đặt lại"
        filterPanel.querySelector(".btn-reset-filter").addEventListener("click", () => {
            // Lấy danh sách hàng MỖI KHI ĐẶT LẠI để hiển thị lại tất cả
            const allRowsToReset = Array.from(tableBody.querySelectorAll("tr"));
            filterPanel.querySelector("#dateFromFilter").value = "";
            filterPanel.querySelector("#dateToFilter").value = "";
            filterPanel.querySelector("#serviceFilter").value = "all";
            filterPanel.querySelector("#paymentFilter").value = "all";

            allRowsToReset.forEach(row => {
                row.style.display = "";
            });
            filterPanel.classList.remove("active");
        });

        // ===== CODE CŨ CỦA BẠN (Đã gộp và sửa lỗi) =====

        // --- GÁN SỰ KIỆN CLICK CHO NÚT "THÊM MỚI" ---
        addButton.addEventListener('click', openAddModal);

        // --- XỬ LÝ KHI SUBMIT FORM ---
        editForm.onsubmit = function (e) {
            e.preventDefault();
            const mode = editForm.dataset.mode;

            if (mode === 'add') {
                const newRow = document.createElement('tr');
                const serviceSelect = document.getElementById("service");
                const selectedServiceText = serviceSelect.options[serviceSelect.selectedIndex].text;

                newRow.innerHTML = `
                    <td data-id="appointmentId">${document.getElementById("appointmentId").value}</td>
                    <td data-id="appointmentDate">${document.getElementById("appointmentDate").value}</td>
                    <td data-id="appointmentTime">${document.getElementById("appointmentTime").value}</td>
                    <td data-id="customerName">${document.getElementById("customerName").value}</td>
                    <td data-id="phoneNumber">${document.getElementById("phoneNumber").value}</td>
                    <td data-id="petName">${document.getElementById("petName").value}</td>
                    <td data-id="service">${selectedServiceText}</td>
                    <td>Chưa thanh toán</td>
                    <td>
                        <button class="icon-button edit-button"><i class="fas fa-edit"></i></button>
                        <button class="icon-button invoice-button"><i class="fas fa-file-invoice"></i></button>
                        <button class="icon-button delete-button"><i class="fas fa-times"></i></button>                     
                    </td>
                `;
                tableBody.appendChild(newRow);
                alert("Đã thêm lịch hẹn thành công!");
            } else if (mode === 'edit') {
                alert("Đã lưu thay đổi!");
            }
            closeEditModal();
        };
        
        // Gán sự kiện cho các nút trong bảng (cách này tốt hơn là dùng onclick trong HTML)
        tableBody.addEventListener('click', function(event) {
            const target = event.target;
            const editButton = target.closest('.edit-button');
            const invoiceButton = target.closest('.invoice-button');
            const deleteButton = target.closest('.delete-button');

            if (editButton) openEditModal(editButton);
            if (invoiceButton) openInvoiceModal(invoiceButton);
            if (deleteButton) showDeletePopup(deleteButton);
        });


        // --- HỦY LỊCH HẸN ---
        const popup = document.getElementById("cancel-popup");
        popup.querySelector(".btn-cancel").addEventListener("click", () => popup.style.display = "none");
        popup.querySelector(".btn-confirm").addEventListener("click", () => {
            popup.style.display = "none";
            alert("Đã hủy lịch hẹn!");
        });

        // --- XỬ LÝ CLICK RA NGOÀI ---
        window.onclick = function(event) {
            const invoiceModal = document.getElementById("invoiceModal");
            if (event.target === editModal) closeEditModal();
            if (event.target === invoiceModal) closeInvoiceModal();
            if (event.target === popup) popup.style.display = 'none';
        };
    });

    // --- CÁC HÀM TOÀN CỤC (GLOBAL FUNCTIONS) ---

    function openEditModal(button) {
        const row = button.closest("tr");
        const getCellText = (id) => row.querySelector(`td[data-id="${id}"]`)?.innerText.trim() || "";
        
        document.getElementById("appointmentId").value = getCellText("appointmentId");
        document.getElementById("customerName").value = getCellText("customerName");
        document.getElementById("phoneNumber").value = getCellText("phoneNumber");
        document.getElementById("appointmentDate").value = getCellText("appointmentDate");
        document.getElementById("appointmentTime").value = getCellText("appointmentTime");
        document.getElementById("petName").value = getCellText("petName");

        const serviceSelect = document.getElementById("service");
        const serviceText = getCellText("service");
        let serviceValue = '';
        for (let i = 0; i < serviceSelect.options.length; i++) {
            if (serviceSelect.options[i].text === serviceText) {
                serviceValue = serviceSelect.options[i].value;
                break;
            }
        }
        serviceSelect.value = serviceValue;
        
        document.getElementById("modalTitle").textContent = "Chỉnh sửa lịch hẹn";
        document.getElementById("modalSubmitButton").textContent = "Lưu thay đổi";
        document.getElementById("editAppointmentForm").dataset.mode = "edit";
        document.getElementById("editModal").style.display = "flex";
    }

    function openAddModal() {
        const editForm = document.getElementById("editAppointmentForm");
        editForm.reset();
        document.getElementById("modalTitle").textContent = "Thêm mới lịch hẹn";
        document.getElementById("modalSubmitButton").textContent = "Thêm lịch hẹn";
        const tableBody = document.querySelector(".appointment-table tbody");
        document.getElementById("appointmentId").value = `LH${String(tableBody.rows.length + 1).padStart(3, '0')}`;
        editForm.dataset.mode = "add";
        document.getElementById("editModal").style.display = "flex";
    }

    function closeEditModal() {
        document.getElementById("editModal").style.display = "none";
    }

    function openInvoiceModal(button) {
        const row = button.closest("tr");
        const getCellText = (id) => row.querySelector(`td[data-id="${id}"]`)?.innerText.trim() || "";
      
        document.getElementById("invoiceAppointmentId").textContent = getCellText("appointmentId");
        document.getElementById("invoiceCustomerName").textContent = getCellText("customerName");
        document.getElementById("invoicePhoneNumber").textContent = getCellText("phoneNumber");
        document.getElementById("invoiceAppointmentDate").textContent = getCellText("appointmentDate");
        document.getElementById("invoicePetName").textContent = getCellText("petName");
        document.getElementById("invoiceService").textContent = getCellText("service");
        document.getElementById("invoicePrice").textContent = "200.000 VNĐ"; // GIÁ
        document.getElementById("invoiceModal").style.display = "flex";
    }

    function closeInvoiceModal() {
        document.getElementById("invoiceModal").style.display = "none";
    }

    function processInvoice() {
        const maLH = document.getElementById("invoiceAppointmentId").textContent;
        alert(`Đã yêu cầu xuất hóa đơn cho Mã LH: ${maLH}`); 
        closeInvoiceModal();
    }

    function showDeletePopup() {
        document.getElementById("cancel-popup").style.display = "flex";
    }
</script>
  </body>
</html>
