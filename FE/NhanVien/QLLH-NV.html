<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Paws Pet House - Quản lý Lịch hẹn</title>
    <link rel="stylesheet" href="QLLH-NV.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
  </head>
  <body>
    <!-- Header ngang trên cùng -->
    <header class="site-header">
      <div class="logo">
        <img
          src="..\Ảnh\logo.png"
          alt="Paw Logo"
          class="logo-icon"
        />
        PAWS PET HOUSE
      </div>
    </header>

    <!-- Chia 2 cột: sidebar + nội dung -->
    <div class="app-container">
      <!-- Sidebar trái -->
      <aside class="sidebar">
        <nav class="nav-menu">
          <a href="QLDV.html"><i class="fas fa-cogs"></i> Quản lý dịch vụ</a>
          <a href="QLTK.html"><i class="fas fa-user"></i> Quản lý tài khoản</a>
          <a class="active" href="#"><i class="fas fa-calendar-alt"></i> Quản lý lịch hẹn</a>
          <a href="QLTTKH.html"><i class="fas fa-chart-bar"></i> Quản lý thông tin khách hàng</a>
        </nav>
      </aside>

    <!-- Nội dung phải -->
    <div class="content-area">
            <!-- BREADCRUMB + ADMIN -->
            <div class="topbar">
              <span class="breadcrumb">Trang chủ / <strong>Quản lý lịch hẹn</strong></span>
              <div class="user-admin">
                <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" alt="Avatar" class="avatar">
                Admin
              </div>
            </div>
          
        <!-- QUẢN LÝ LỊCH HẸN -->
        <div class="table-container">
          <h3 class="table-title">DANH SÁCH LỊCH HẸN</h3>
          <!-- TÌM KIẾM + BỘ LỌC + THÊM MỚI -->
          <div class="table-toolbar">
            <div class="toolbar-left">
              <div class="search-group">
                <input type="text" placeholder="Tìm kiếm" class="search-box" />
                <button class="search-button">
                  <i class="fas fa-search"></i>
                </button>
              </div>
              <button class="filter-button">
                <i class="fas fa-filter"></i> Bộ lọc
                <i class="fas fa-caret-down"></i>
              </button>
            </div>
            <button class="add-button">
              <i class="fas fa-plus white-icon"></i>
              Thêm mới
            </button>
          </div>

              <!-- BẢNG DỮ LIỆU LỊCH HẸN -->
              <table class="appointment-table">
                <thead>
                  <tr>
                    <th>Mã lịch hẹn</th>
                    <th>Ngày hẹn</th>
                    <th>Giờ hẹn</th>
                    <th>Khách hàng</th>   
                    <th>Số điện thoại</th>                 
                    <th>Thú cưng</th>
                    <th>Dịch vụ</th>
                    <th>Thanh toán</th>
                    <th>Tác vụ</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td data-id="appointmentId">LH001</td>
                    <td data-id="appointmentDate">2025-05-15</td>
                    <td data-id="appointmentTime">10:00</td>
                    <td data-id="customerName">Phạm Hoàng Hưng</td>
                    <td data-id="phoneNumber">0842672987</td>
                    <td data-id="petName">Bánh bao</td>
                    <td data-id="service">Tắm rửa</td>
                    <td>Chưa thanh toán</td>
                    <td>
                      <button class="icon-button edit-button" onclick="openEditModal(this)">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button class="icon-button invoice-button" onclick="openInvoiceModal(this)">
                        <i class="fas fa-file-invoice"></i>
                      </button>
                      <button class="icon-button delete-button" onclick="showDeletePopup()">
                        <i class="fas fa-times"></i>
                      </button>                     
                    </td>
                  </tr>
                </tbody>
              </table>

              <!-- MODAL CHỈNH SỬA LỊCH HẸN -->
              <div id="editModal" class="modal" style="display: none">
                <div class="modal-content">
                  <span class="close-btn" onclick="closeEditModal()">&times;</span>
                  <h3 id="modalTitle">Chỉnh sửa lịch hẹn</h3>
                  <form id="editAppointmentForm">
                    <label for="appointmentId">Mã lịch hẹn:</label>
                    <input type="text" id="appointmentId" name="appointmentId" readonly />

                    <label for="customerName">Khách hàng:</label>
                    <input type="text" id="customerName" name="customerName" required />

                    <label for="phoneNumber">Số điện thoại:</label>
                    <input type="text" id="phoneNumber" name="phoneNumber" required />

                    <label for="appointmentDate">Ngày hẹn:</label>
                    <input type="date" id="appointmentDate" name="appointmentDate" required />

                    <label for="appointmentTime">Khung giờ:</label>
                    <select id="appointmentTime" required>
                      <option value="" disabled selected hidden>-- Chọn khung giờ --</option>
                      <option value="08:00">08:00</option>
                      <option value="10:00">10:00</option>
                      <option value="14:00">14:00</option>
                      <option value="16:00">16:00</option>
                    </select>

                    <label for="petName">Thú cưng:</label>
                    <select id="petName" required>
                      <option value="" disabled selected hidden>-- Chọn thú cưng --</option>
                      <option value="banhbao">Bánh bao</option>
                      <option value="new" style="color:#880e4f;">Thêm mới...</option>
                    </select>

                    <label for="service">Loại dịch vụ:</label>
                    <select id="service" required>
                      <option value="" disabled selected hidden>-- Chọn dịch vụ --</option>
                      <option value="tamrua">Tắm rửa</option>
                      <option value="kham">Tạo kiểu lông</option>
                      <option value="khachsan">Khách sạn thú cưng</option>
                    </select>    

                    <button type="submit" class="save-button" id="modalSubmitButton">Lưu thay đổi</button>
                  </form>
                </div>
              </div>

              <!-- MODAL XUẤT HÓA ĐƠN -->
              <div id="invoiceModal" class="modal" style="display: none">
                <div class="modal-content">
                  <span class="close-btn" onclick="closeInvoiceModal()">×</span>
                  <h3>Xuất Hóa Đơn</h3>
                  <div id="invoice-details">
                    <p><strong>Mã lịch hẹn:</strong> <span id="invoiceAppointmentId"></span></p>
                    <p><strong>Khách hàng:</strong> <span id="invoiceCustomerName"></span></p>
                    <p><strong>Số điện thoại:</strong> <span id="invoicePhoneNumber"></span></p>
                    <p><strong>Ngày hẹn:</strong> <span id="invoiceAppointmentDate"></span></p>
                    <p><strong>Thú cưng:</strong> <span id="invoicePetName"></span></p>
                    <p><strong>Dịch vụ:</strong> <span id="invoiceService"></span></p>
                    <p><strong>Giá tiền:</strong> <span id="invoicePrice"></span></p>
                  </div>
                  <button type="button" class="save-button" onclick="processInvoice()">Xuất hóa đơn</button>
                </div>
              </div>
              
              <!-- POP-UP HỦY LỊCH HẸN -->
              <div id="cancel-popup" class="popup-overlay">
                <div class="popup-box">
                  <div class="popup-header">HỦY LỊCH HẸN</div>
                  <div class="popup-body">
                    <div class="popup-content">
                      <img src="https://png.pngtree.com/png-vector/20230314/ourmid/pngtree-hazard-icon-vector-png-image_6647993.png" class="warning-icon" alt="Warning">
                      <p>Bạn có chắc chắn muốn hủy lịch hẹn đã chọn?</p>
                    </div>
                    <div class="popup-actions">
                      <button class="btn btn-confirm">Xác nhận</button>
                      <button class="btn btn-cancel">Quay lại</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- PHÂN TRANG -->
              <div class="pagination">
                <button class="page-btn">«</button>
                <span>Trang</span>
                <input type="number" value="1" min="1" class="page-input" />
                <span>/ 10</span>
                <button class="page-btn">»</button>
              </div>
            
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- KHAI BÁO BIẾN TOÀN CỤC ---
    const editModal = document.getElementById("editModal");
    const editForm = document.getElementById("editAppointmentForm");
    const modalTitle = document.getElementById("modalTitle");
    const modalSubmitButton = document.getElementById("modalSubmitButton");
    const addButton = document.querySelector(".add-button");
    const tableBody = document.querySelector(".appointment-table tbody");

    // --- HÀM MỞ MODAL CHẾ ĐỘ CHỈNH SỬA ---
    function openEditModal(button) {
        // Lấy dòng hiện tại
        const row = button.closest("tr");
        
        // Gán dữ liệu vào form
        const getCellText = (id) => row.querySelector(`td[data-id="${id}"]`)?.innerText.trim() || "";
        document.getElementById("appointmentId").value = getCellText("appointmentId");
        document.getElementById("customerName").value = getCellText("customerName");
        document.getElementById("phoneNumber").value = getCellText("phoneNumber");
        document.getElementById("appointmentDate").value = getCellText("appointmentDate");
        document.getElementById("appointmentTime").value = getCellText("appointmentTime");
        document.getElementById("petName").value = getCellText("petName");
        document.getElementById("service").value = getCellText("service");

        // Thiết lập giao diện cho chế độ "Sửa"
        modalTitle.textContent = "Chỉnh sửa lịch hẹn";
        modalSubmitButton.textContent = "Lưu thay đổi";
        document.getElementById("appointmentId").readOnly = true;
        document.getElementById("customerName").readOnly = true;
        document.getElementById("phoneNumber").readOnly = true;

        // Đặt chế độ cho form
        editForm.dataset.mode = "edit";
        
        // Hiện modal
        editModal.style.display = "flex";
    }

    // --- HÀM MỞ MODAL CHẾ ĐỘ THÊM MỚI ---
    function openAddModal() {
        // Reset form về trạng thái trống
        editForm.reset();

        // Thiết lập giao diện cho chế độ "Thêm"
        modalTitle.textContent = "Thêm mới lịch hẹn";
        modalSubmitButton.textContent = "Thêm lịch hẹn";
        
        // Cho phép nhập liệu các trường
        document.getElementById("appointmentId").value = `LH${String(tableBody.rows.length + 1).padStart(3, '0')}`; // Tự động tạo mã
        document.getElementById("appointmentId").readOnly = true;
        document.getElementById("customerName").readOnly = false;
        document.getElementById("phoneNumber").readOnly = false;

        // Đặt chế độ cho form
        editForm.dataset.mode = "add";

        // Hiện modal
        editModal.style.display = "flex";
    }

    // --- HÀM ĐÓNG MODAL ---
    function closeEditModal() {
        editModal.style.display = "none";
    }

    // --- XỬ LÝ KHI SUBMIT FORM ---
    editForm.onsubmit = function (e) {
        e.preventDefault();
        const mode = editForm.dataset.mode;

        if (mode === 'add') {
            // Lấy dữ liệu từ form
            const newAppointment = {
                id: document.getElementById("appointmentId").value,
                date: document.getElementById("appointmentDate").value,
                time: document.getElementById("appointmentTime").value,
                customer: document.getElementById("customerName").value,
                phone: document.getElementById("phoneNumber").value,
                pet: document.getElementById("petName").value,
                service: document.getElementById("service").value,
            };

            // Tạo hàng mới trong bảng
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td data-id="appointmentId">${newAppointment.id}</td>
                <td data-id="appointmentDate">${newAppointment.date}</td>
                <td data-id="appointmentTime">${newAppointment.time}</td>
                <td data-id="customerName">${newAppointment.customer}</td>
                <td data-id="phoneNumber">${newAppointment.phone}</td>
                <td data-id="petName">${newAppointment.pet}</td>
                <td data-id="service">${newAppointment.service}</td>
                <td>Chưa thanh toán</td>
                <td>
                    <button class="icon-button edit-button" onclick="openEditModal(this)">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="icon-button invoice-button" onclick="openInvoiceModal(this)">
                        <i class="fas fa-file-invoice"></i>
                    </button>
                    <button class="icon-button delete-button" onclick="showDeletePopup()">
                        <i class="fas fa-times"></i>
                    </button>                     
                </td>
            `;
            tableBody.appendChild(newRow);
            alert("Đã thêm lịch hẹn thành công!");

        } else if (mode === 'edit') {
            alert("Đã lưu thay đổi!");
        }

        closeEditModal();
    };

    // --- GÁN SỰ KIỆN CLICK CHO NÚT ---
    addButton.addEventListener('click', openAddModal);

    // Hàm mở Modal Xuất Hóa Đơn
    function openInvoiceModal(button) {
      const row = button.closest("tr");

      const getCellText = (cellIndexOrDataId) => {
        if (typeof cellIndexOrDataId === 'number') {
            return row.cells[cellIndexOrDataId]?.innerText.trim() || "";
        }
        return row.querySelector(`td[data-id="${cellIndexOrDataId}"]`)?.innerText.trim() || "";
      };
      
      document.getElementById("invoiceAppointmentId").textContent = getCellText("appointmentId");
      document.getElementById("invoiceCustomerName").textContent = getCellText("customerName");
      document.getElementById("invoicePhoneNumber").textContent = getCellText("phoneNumber");
      document.getElementById("invoiceAppointmentDate").textContent = getCellText("appointmentDate"); // + " " + getCellText("appointmentTime"); // Nếu muốn gộp ngày và giờ
      document.getElementById("invoicePetName").textContent = getCellText("petName");
      document.getElementById("invoiceService").textContent = getCellText("service");
      document.getElementById("invoicePrice").textContent = "200.000 VNĐ"; //GIÁ
      document.getElementById("invoiceModal").style.display = "flex";
    }

    function closeInvoiceModal() {
      document.getElementById("invoiceModal").style.display = "none";
    }

    function processInvoice() {
      // Lấy thông tin từ modal để xử lý (nếu cần)
      const maLH = document.getElementById("invoiceAppointmentId").textContent;
      const tenKH = document.getElementById("invoiceCustomerName").textContent;

      alert(`Đã yêu cầu xuất hóa đơn cho Mã LH: ${maLH}, Khách hàng: ${tenKH}`); 
      
      closeInvoiceModal();
    }

    window.onclick = function(event) {
      const editModal = document.getElementById("editModal");
      const invoiceModal = document.getElementById("invoiceModal");
      const cancelPopupOverlay = document.getElementById("cancel-popup");
      if (event.target === editModal) {
        closeEditModal();
      }
      if (event.target === invoiceModal) {
        closeInvoiceModal();
      }
      if (event.target === cancelPopupOverlay) {
    cancelPopupOverlay.style.display = 'none'; // Trực tiếp ẩn popup
    }
    };

    // HỦY LỊCH HẸN
      const popup = document.getElementById("cancel-popup");
      const cancelBtn = document.querySelector(".btn-cancel");
      const confirmBtn = document.querySelector(".btn-confirm");

      function showDeletePopup() {
        popup.style.display = "flex";
      }

      cancelBtn.addEventListener("click", () => popup.style.display = "none");
      confirmBtn.addEventListener("click", () => {
        popup.style.display = "none";
        alert("Đã hủy lịch hẹn!");
      });

  </script>
  </body>
</html>
