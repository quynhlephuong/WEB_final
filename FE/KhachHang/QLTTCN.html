<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Paws Pet House</title>
  <link rel="stylesheet" href="QLTTCN.css" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  />
</head>
<body>

  <!-- Header ngang tr√™n c√πng -->
  <header class="site-header">
    <div class="logo">
        <img 
        src="..\·∫¢nh\logo.png" 
        alt="Paw Logo" 
        class="logo-icon"
        />
        PAWS PET HOUSE
    </div>    
    <div class="account">
      <img
      src="https://cdn-icons-png.flaticon.com/512/147/147144.png" 
      alt="Avatar" 
      class="avatar">
      <span id="username-display">Pecute</span>
    </div>  
  </header>
  
  <!-- Chia 2 c·ªôt: sidebar + n·ªôi dung -->
   <div class="app-container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <nav class="nav-menu">
          <a href="QLLH_KH.html"><i class="fas fa-calendar-alt"></i> Qu·∫£n l√Ω l·ªãch h·∫πn</a>
          <a class="active" href="QLTTCN.html"><i class="fas fa-chart-bar"></i> Qu·∫£n l√Ω th√¥ng tin c√° nh√¢n</a>
        </nav>
      </aside>
  
   <!-- N·ªôi dung b√™n ph·∫£i -->
    <section class="content-area">
          <!-- BREADCRUMB -->
            <div class="topbar">
              <span class="breadcrumb">Trang ch·ªß / <strong>Qu·∫£n l√Ω th√¥ng tin c√° nh√¢n</strong></span>
            </div>

      <!-- container d·∫≠p n·ªïi -->
      <div class="table-container">
          <!-- TH√îNG TIN C√Å NH√ÇN + TH√ö C∆ØNG -->
          <div id="info-section">
            <div class="profile-section">
              <h2>TH√îNG TIN C√Å NH√ÇN</h2>
              <div class="info-row">
                <div><strong>H·ªç v√† t√™n:</strong> <span id="displayHoTen">Ch∆∞a r√µ</span></div>
              </div>
              <div class="info-row">
                <div><strong>ƒê·ªãa ch·ªâ:</strong> <span id="displayDiaChi">Ch∆∞a r√µ</span></div>
                <div><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> <span id="displaySoDienThoai">Ch∆∞a r√µ</span></div>
              </div>
              <div class="info-row">
                <div><strong>Gi·ªõi t√≠nh:</strong> <span id="displayGioiTinh">Ch∆∞a r√µ</span></div>
                <div><strong>Email:</strong> <span id="displayEmail">Ch∆∞a r√µ</span></div>
              </div>
              <button id="editPersonalInfoBtn" class="edit-btn">CH·ªàNH S·ª¨A</button>
            </div>

            <!-- TH√îNG TIN TH√ö C∆ØNG -->
            <div class="pet-section">
              <h2>TH√îNG TIN TH√ö C∆ØNG</h2>
              <ul id="pet-list" class="pet-list">
              </ul>
            </div>
          </div>

          <!-- Modal Ch·ªânh s·ª≠a th√¥ng tin c√° nh√¢n -->
          <div id="editPersonalInfoModal" class="modal">
              <div class="modal-content">
                  <span class="close-button">√ó</span>
                  <h2>CH·ªàNH S·ª¨A TH√îNG TIN C√Å NH√ÇN</h2>
                  <form id="editPersonalInfoForm">
                      <div class="form-group">
                          <label for="modalHoTen">H·ªç v√† t√™n:</label>
                          <input type="text" id="modalHoTen" name="hoTen" oninput="restrictNameInput(this)">
                          <div class="error-message" id="errorHoTen"></div>
                      </div>
                      <div class="form-group">
                          <label for="modalGioiTinh">Gi·ªõi t√≠nh:</label>
                          <select id="modalGioiTinh" name="gioiTinh">
                              <option value="Nam">Nam</option>
                              <option value="N·ªØ">N·ªØ</option>
                          </select>
                      </div>
                      <div class="form-group">
                          <label for="modalDiaChi">ƒê·ªãa ch·ªâ:</label>
                          <input type="text" id="modalDiaChi" name="diaChi">
                      </div>
                      <div class="form-group">
                          <label for="modalSoDienThoai">S·ªë ƒëi·ªán tho·∫°i:</label>
                          <input type="tel" id="modalSoDienThoai" name="soDienThoai" maxlength="10" oninput="restrictPhoneInput(this)">
                          <div class="error-message" id="errorSoDienThoai"></div>                      
                      </div>
                      <div class="form-group">
                          <label for="modalEmail">Email:</label>
                          <input type="email" id="modalEmail" name="email">
                      </div>
                      <div class="modal-actions">
                          <button type="button" class="cancel-btn">H·ªßy</button>
                          <button type="submit" class="save-btn">L∆∞u</button>
                      </div>
                  </form>
              </div>
          </div>

          <!-- ƒê·ªîI M·∫¨T KH·∫®U -->
          <div id="change-password-section" style="display: none;">
            <h2>ƒê·ªîI M·∫¨T KH·∫®U</h2>
            <label>M·∫≠t kh·∫©u hi·ªán t·∫°i <span style="color: red;">(*)</span></label>
            <input type="password" id="currentPassword" required>
            <label>M·∫≠t kh·∫©u m·ªõi <span style="color: red;">(*)</span></label>
            <input type="password" id="newPassword" required>
            <label>Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi <span style="color: red;">(*)</span></label>
            <input type="password" id="confirmPassword" required>
            <div class="button-group">
              <button onclick="cancelChange()">H·ªßy</button>
              <button onclick="savePassword()">L∆∞u</button>
            </div>
            <p id="message" style="color: red;"></p>
          </div>

          <!-- GIAO DI·ªÜN GI·ªöI THI·ªÜU -->
        <div id="about-section" style="display: none;" class="about-container">
          <h2 class="section-title">üêæ Gi·ªõi thi·ªáu v·ªÅ <span>Paws Pet House</span> üêæ</h2>
          <div class="about-content">
            <div class="about-image">
              <img src="https://product.hstatic.net/200000108863/product/z6077214838249_103b21cc7940d83783acb106519b357d_e5a3e180adf74b93bdfc3a7039210d96_large.jpg" alt="Paws Pet House - cute kittens" />
            </div>
            <div class="about-text">
              <p>Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi <strong>Paws Pet House</strong>, n∆°i n√¢ng cao s·ª©c kh·ªèe v√† s·ª± h·∫°nh ph√∫c c·ªßa nh·ªØng th√†nh vi√™n l√¥ng l·ªëm trong gia ƒë√¨nh b·∫°n!</p>
              <p>T·∫°i <strong>Paws Pet House</strong>, ch√∫ng t√¥i cam k·∫øt mang ƒë·∫øn cho b·∫°n v√† c√°c b√© c∆∞ng c·ªßa b·∫°n kh√¥ng gian th∆∞ gi√£n v√† chƒÉm s√≥c t·ªët nh·∫•t. V·ªõi ƒë·ªôi ng≈© chuy√™n gia gi√†u kinh nghi·ªám v√† y√™u th∆∞∆°ng ƒë·ªông v·∫≠t, ch√∫ng t√¥i cung c·∫•p nh·ªØng d·ªãch v·ª• chƒÉm s√≥c ch·∫•t l∆∞·ª£ng cao t·ª´ chƒÉm s√≥c da l√¥ng, t·∫Øm g·ªôi, c·∫Øt t·ªâa m√≥ng, ƒë·∫øn massage th∆∞ gi√£n v√† ƒëi·ªÅu tr·ªã y t·∫ø.</p>
              <p>Kh√¥ng ch·ªâ l√† n∆°i chƒÉm s√≥c th√∫ c∆∞ng, <strong>Paws Pet House</strong> c·ªßa ch√∫ng t√¥i c≈©ng l√† n∆°i ƒë·ªÉ th√∫ c∆∞ng c·ªßa b·∫°n t·∫≠n h∆∞·ªüng nh·ªØng tr·∫£i nghi·ªám th√∫ v·ªã v√† b·ªï √≠ch. V·ªõi kh√¥ng gian tho·∫£i m√°i v√† thi·∫øt k·∫ø hi·ªán ƒë·∫°i, ch√∫ng t√¥i ƒë·∫£m b·∫£o m·ªói l·∫ßn ƒë·∫øn ƒë√¢y, th√∫ c∆∞ng c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c ƒë·ªëi ƒë√£i nh∆∞ m·ªôt ng√¥i sao th·ª±c th·ª•.</p>
              <ul class="features">
                <li>üêæ D·ªãch v·ª• ƒëa d·∫°ng v√† to√†n di·ªán cho th√∫ c∆∞ng</li>
                <li>üêæ Trang thi·∫øt b·ªã hi·ªán ƒë·∫°i v√† an to√†n</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
</section>
<script>document.addEventListener('DOMContentLoaded', function () {
    const username = localStorage.getItem('USERNAME') || 'Pecute';
    document.getElementById('username-display').textContent = username;
});


  async function fetchPets() {
    try {
      const response = await fetch('http://localhost:3333/pets/own', {
        method: 'POST',
        headers: {
          'accept': '*/*',
        },
        credentials: 'include'
      });

      const result = await response.json();
      const petList = document.getElementById('pet-list');
      
      petList.innerHTML = ''; 

      if (result.data.length === 0) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('no-data-message');
        msgDiv.textContent = 'H√ÉY LI√äN H·ªÜ V·ªöI ADMIN ƒê·ªÇ X√ÅC NH·∫¨N TH√ö C∆ØNG H·ª¢P L·ªÜ';
        petList.appendChild(msgDiv);
      } else {
        result.data.forEach(pet => {
          const petDiv = document.createElement('div');
          petDiv.classList.add('info-row');
          petDiv.innerHTML = `
            <div><strong>T√™n:</strong> <span>${pet.name}</span></div>
            <div><strong>Gi·ªëng lo√†i:</strong> <span>${pet.breed}</span></div>
            <div><strong>Lo√†i:</strong> <span>${pet.species}</span></div>
            <div><strong>C√¢n n·∫∑ng:</strong> <span>${pet.weight}kg</span></div>
            <div><strong>T√¨nh tr·∫°ng:</strong> <span>${pet.status}</span></div>
          `;
          petList.appendChild(petDiv);
        });
      }

    } catch (error) {
      console.error('L·ªói khi l·∫•y danh s√°ch th√∫ c∆∞ng:', error);
    }
  }

  window.addEventListener('DOMContentLoaded', fetchPets);

  async function fetchUserProfile() {
    try {
      const response = await fetch('http://localhost:3333/auth/me', {
        method: 'GET',
        headers: {
          'accept': '*/*'
        },
        credentials: 'include'
      });

      if (!response.ok) throw new Error('L·ªói khi g·ªçi API');

      const data = await response.json();

      document.getElementById('displayHoTen').textContent = data.profile.name || '';
      document.getElementById('displayDiaChi').textContent = data.profile.address || '';
      document.getElementById('displaySoDienThoai').textContent = data.profile.phone || '';
      document.getElementById('displayGioiTinh').textContent = data.profile.gender === false ? 'Nam' : (data.profile.gender === true ? 'N·ªØ' : 'Kh√°c');
      document.getElementById('displayEmail').textContent = data.profile.email || '';

      const accountName = document.querySelector('.account span');
      if (accountName) accountName.textContent = data.username || 'Ng∆∞·ªùi d√πng';

    } catch (error) {
      console.error('L·ªói khi l·∫•y th√¥ng tin ng∆∞·ªùi d√πng:', error);
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    fetchUserProfile();
  });

  document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('editPersonalInfoModal');
    const openModalBtn = document.getElementById('editPersonalInfoBtn');
    const closeModalBtn = modal.querySelector('.close-button');
    const cancelModalBtn = modal.querySelector('.cancel-btn');
    const editForm = document.getElementById('editPersonalInfoForm');

    // Get display elements for personal info
    const displayHoTen = document.getElementById('displayHoTen');
    const displayGioiTinh = document.getElementById('displayGioiTinh');
    const displayDiaChi = document.getElementById('displayDiaChi');
    const displaySoDienThoai = document.getElementById('displaySoDienThoai');
    const displayEmail = document.getElementById('displayEmail');

    // Get form input elements
    const modalHoTen = document.getElementById('modalHoTen');
    const modalNgaySinh = document.getElementById('modalNgaySinh');
    const modalGioiTinh = document.getElementById('modalGioiTinh');
    const modalDiaChi = document.getElementById('modalDiaChi');
    const modalSoDienThoai = document.getElementById('modalSoDienThoai');
    const modalEmail = document.getElementById('modalEmail');

    // Function to open the modal and populate form
    function openEditModal() {
        // Populate form with current values
        modalHoTen.value = displayHoTen.textContent;
        modalGioiTinh.value = displayGioiTinh.textContent;
        modalDiaChi.value = displayDiaChi.textContent;
        modalSoDienThoai.value = displaySoDienThoai.textContent;
        modalEmail.value = displayEmail.textContent;

        modal.style.display = 'flex'; // Use flex to center content
    }

    // Function to close the modal
    function closeEditModal() {
        modal.style.display = 'none';
    }

    // Event listener for opening the modal
    if (openModalBtn) {
        openModalBtn.addEventListener('click', openEditModal);
    }

    // Event listener for closing the modal with the 'X' button
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeEditModal);
    }

    // Event listener for closing the modal with the 'H·ªßy' button
    if (cancelModalBtn) {
        cancelModalBtn.addEventListener('click', closeEditModal);
    }

    // Event listener for closing the modal by clicking outside of it
    window.addEventListener('click', function(event) {
        if (event.target == modal) {
            closeEditModal();
        }
    });

    // Ki·ªÉm tra h·ªç v√† t√™n kh√¥ng ch·ª©a s·ªë
    function isValidName(name) {
      return /^[\p{L}\s]+$/u.test(name); // Ch·ªâ ch·∫•p nh·∫≠n ch·ªØ c√°i v√† kho·∫£ng tr·∫Øng
    }
    // Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i ch·ªâ ch·ª©a s·ªë v√† ƒë√∫ng 10 ch·ªØ s·ªë
    function isValidPhone(phone) {
      return /^\d{10}$/.test(phone); // Ch·ªâ ch·∫•p nh·∫≠n ƒë√∫ng 10 ch·ªØ s·ªë
    }
    
    // Gi·ªõi h·∫°n input h·ªç v√† t√™n (ch·ªâ cho ph√©p ch·ªØ c√°i v√† kho·∫£ng tr·∫Øng)
    function restrictNameInput(input) {
      input.value = input.value.replace(/[^\p{L}\s]/gu, '');
      // X√≥a c·∫£nh b√°o khi ng∆∞·ªùi d√πng nh·∫≠p l·∫°i ƒë√∫ng
      if (isValidName(input.value)) {
        input.classList.remove('invalid');
        document.getElementById('errorHoTen').textContent = '';
      }
    }
    // Gi·ªõi h·∫°n input s·ªë ƒëi·ªán tho·∫°i (ch·ªâ cho ph√©p s·ªë)
    function restrictPhoneInput(input) {
      input.value = input.value.replace(/\D/g, '');
      if (isValidPhone(input.value)) {
        input.classList.remove('invalid');
        document.getElementById('errorSoDienThoai').textContent = '';
      }
    }
    
    // Event listener for form submission (saving changes)
    if (editForm) {
      editForm.addEventListener('submit', async function(event) {
          event.preventDefault();

          const name = modalHoTen.value.trim();
          const genderStr = modalGioiTinh.value;
          const address = modalDiaChi.value.trim();
          const phone = modalSoDienThoai.value.trim();
          const email = modalEmail.value.trim();
           // X√≥a l·ªói c≈©
          document.getElementById('errorHoTen').textContent = '';
          document.getElementById('errorSoDienThoai').textContent = '';
          modalHoTen.classList.remove('invalid');
          modalSoDienThoai.classList.remove('invalid');
    
          let hasError = false;
    
          // Ki·ªÉm tra h·ªç t√™n
          if (!isValidName(name)) {
            document.getElementById('errorHoTen').textContent = "Ch·ªâ nh·∫≠p ch·ªØ v√† kho·∫£ng tr·∫Øng, kh√¥ng ch·ª©a s·ªë!";
            modalHoTen.classList.add('invalid');
            hasError = true;
          }
    
          // Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i
          if (!isValidPhone(phone)) {
            document.getElementById('errorSoDienThoai').textContent = "S·ªë ƒëi·ªán tho·∫°i ph·∫£i ƒë√∫ng 10 ch·ªØ s·ªë!";
            modalSoDienThoai.classList.add('invalid');
            hasError = true;
          }
    
          if (hasError) return; // Ng∆∞ng n·∫øu c√≥ l·ªói
          const gender = genderStr === 'Nam';

          const payload = {
              name,
              gender,
              address,
              phone,
              email
          };

          try {
              const response = await fetch('http://localhost:3333/accounts', {
                  method: 'PATCH',
                  headers: {
                      'accept': '*/*',
                      'Content-Type': 'application/json'
                  },
                  credentials: 'include',
                  body: JSON.stringify(payload)
              });

              if (!response.ok) {
                  const errorData = await response.json();
                  throw new Error(errorData.message || 'C·∫≠p nh·∫≠t th·∫•t b·∫°i');
              }

              displayHoTen.textContent = name;
              displayGioiTinh.textContent = genderStr;
              displayDiaChi.textContent = address;
              displaySoDienThoai.textContent = phone;
              displayEmail.textContent = email;

              closeEditModal();
              alert('C·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n th√†nh c√¥ng!');
          } catch (error) {
              console.error('L·ªói khi c·∫≠p nh·∫≠t th√¥ng tin:', error);
              alert(`L·ªói khi c·∫≠p nh·∫≠t: ${error.message}`);
          }
      });
  }

});
</script>
</body>
</html>
